{% extends "base.html" %}

{% block title %}Upload Resumes | CYGNUSA Elite-Hire{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h1 class="mb-1">Upload Resumes</h1>
        <p class="text-muted">Select a role, adjust the job description, and evaluate candidates.</p>
    </div>
</div>

<form action="/upload" method="post" enctype="multipart/form-data" class="card shadow-soft border-0 p-4">
    <div class="accordion" id="jdEditor">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingRole">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#roleSection" aria-expanded="true" aria-controls="roleSection">
                    Role Selection & JD Preview
                </button>
            </h2>
            <div id="roleSection" class="accordion-collapse collapse show" aria-labelledby="headingRole" data-bs-parent="#jdEditor">
                <div class="accordion-body">
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <label for="job_role" class="form-label">Job Role</label>
                            <select id="job_role" name="job_role" class="form-select">
                                <option value="">Select a role</option>
                                {% for role in roles %}
                                    <option value="{{ role }}" {% if role == selected_role %}selected{% endif %}>{{ role }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Defaults reload on refresh.</small>
                        </div>
                        <div class="col-lg-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="text-muted">Fundamentals</h6>
                                            <ul id="fundamentals-preview" class="mb-0"></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body card-content-safe">
                                            <h6 class="text-muted">Required Skills</h6>
                                            <div id="skills-preview"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="text-muted">Experience</h6>
                                            <h4 id="experience-preview">-</h4>
                                            <small class="text-muted">years required</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="text-muted">Education</h6>
                                            <p id="education-preview" class="mb-0">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingEdit">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#editSection" aria-expanded="false" aria-controls="editSection">
                    Edit Job Description
                </button>
            </h2>
            <div id="editSection" class="accordion-collapse collapse" aria-labelledby="headingEdit" data-bs-parent="#jdEditor">
                <div class="accordion-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Fundamentals (one per line)</label>
                            <textarea id="fundamentals" name="fundamentals" rows="5" class="form-control"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Required Skills</label>
                            <div class="input-group mb-2">
                                <input type="text" id="skillInput" class="form-control" placeholder="Add a skill">
                                <button class="btn btn-outline-primary" type="button" id="addSkill">Add</button>
                            </div>
                            <div id="skillBadges" class="mb-2"></div>
                            <input type="hidden" id="skills" name="skills">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Experience (years)</label>
                            <input type="number" id="experience" name="experience" class="form-control" min="0">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Education Requirement</label>
                            <input type="text" id="education" name="education" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingUpload">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#uploadSection" aria-expanded="false" aria-controls="uploadSection">
                    Resume Upload
                </button>
            </h2>
            <div id="uploadSection" class="accordion-collapse collapse" aria-labelledby="headingUpload" data-bs-parent="#jdEditor">
                <div class="accordion-body">
                    <label for="resumes" class="form-label">Upload Resume PDFs</label>
                    <input type="file" id="resumes" name="resumes" accept="application/pdf" multiple class="form-control">
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Evaluate Candidates</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const rolesData = {{ roles_data | tojson }};
    const roleSelect = document.getElementById("job_role");
    const skillsPreview = document.getElementById("skills-preview");
    const fundamentalsPreview = document.getElementById("fundamentals-preview");
    const experiencePreview = document.getElementById("experience-preview");
    const educationPreview = document.getElementById("education-preview");

    const fundamentalsInput = document.getElementById("fundamentals");
    const skillsInput = document.getElementById("skills");
    const experienceInput = document.getElementById("experience");
    const educationInput = document.getElementById("education");
    const skillBadges = document.getElementById("skillBadges");
    const skillInput = document.getElementById("skillInput");

    let currentSkills = [];

    function renderBadges() {
        skillBadges.innerHTML = "";
        currentSkills.forEach((skill, index) => {
            const badge = document.createElement("span");
            badge.className = "skill-badge";
            badge.textContent = skill;
            const button = document.createElement("button");
            button.type = "button";
            button.className = "btn btn-sm btn-link text-danger ms-1 p-0";
            button.innerHTML = "&times;";
            button.addEventListener("click", () => {
                currentSkills.splice(index, 1);
                updateSkillsInput();
                renderBadges();
            });
            badge.appendChild(button);
            skillBadges.appendChild(badge);
        });
    }

    function updateSkillsInput() {
        skillsInput.value = currentSkills.join(", ");
    }

    document.getElementById("addSkill").addEventListener("click", () => {
        const value = skillInput.value.trim();
        if (value) {
            currentSkills.push(value.toLowerCase());
            skillInput.value = "";
            updateSkillsInput();
            renderBadges();
        }
    });

    function renderPreview(role) {
        const data = rolesData[role];
        skillsPreview.innerHTML = "";
        fundamentalsPreview.innerHTML = "";
        if (!data) {
            experiencePreview.textContent = "-";
            educationPreview.textContent = "-";
            skillsPreview.innerHTML = "<span class='text-muted'>Select a role to view requirements.</span>";
            fundamentalsPreview.innerHTML = "<li class='text-muted'>Select a role to view fundamentals.</li>";
            fundamentalsInput.value = "";
            currentSkills = [];
            updateSkillsInput();
            renderBadges();
            experienceInput.value = "";
            educationInput.value = "";
            return;
        }
        data.skills.forEach((skill) => {
            const badge = document.createElement("span");
            badge.className = "skill-badge";
            badge.textContent = skill;
            skillsPreview.appendChild(badge);
        });
        (data.fundamentals || []).forEach((item) => {
            const listItem = document.createElement("li");
            listItem.textContent = item;
            fundamentalsPreview.appendChild(listItem);
        });
        experiencePreview.textContent = data.experience || "-";
        educationPreview.textContent = data.education || "-";
        fundamentalsInput.value = (data.fundamentals || []).join("\n");
        currentSkills = [...(data.skills || [])];
        updateSkillsInput();
        renderBadges();
        experienceInput.value = data.experience || "";
        educationInput.value = data.education || "";
    }

    roleSelect.addEventListener("change", (event) => {
        const role = event.target.value;
        renderPreview(role);
        if (role) {
            fetch("/set-role", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ role }),
            });
        }
    });

    renderPreview(roleSelect.value);
</script>
{% endblock %}
